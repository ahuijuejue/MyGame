--[[
	翻翻乐活动
]]
local FlipFunLayer = class("FlipFunLayer",function()
	return display.newNode()
end)
local NodeBox = import("app.ui.NodeBox")

local boardImage  = "board_flip.png"
local payBtn1 = "flip_pay1.png"
local payBtn2 = "flip_pay2.png"
local refreshBtn1 = "flip_btn1.png"
local refreshBtn2 = "flip_btn2.png"
local flipDiamond = "flip_diamond.png"
local flipFace = "flip_face.png"
local flipBack = "flip_back.png"
local stoneBarBg = "Stone_Bar.png"
local stoneImage = "Stone.png"

function FlipFunLayer:ctor()
	self.closeFunc = nil
	self.allFlipPic = {}
	self:initView()
	self:addNodeEventListener(cc.NODE_EVENT,function (event)
		if event.name == "enter" then
			self:onEnter()
		elseif event.name == "exit" then
			self:onExit()
		end
	end)
	CommonView.animation_show_out(self.board)
end

function FlipFunLayer:touchFlip(index)
	local btn = self.allFlipPic[index]
	btn:setVisible(false)

	local x,y = btn:getPosition()
	local flipPic = display.newSprite(flipFace)
	flipPic:setPosition(x+660,y+255)
	flipPic:setScaleX(-1)
	self.board:addChild(flipPic)

	local x = flipPic:getContentSize().width/2
	local y = flipPic:getContentSize().height/2
	local item = self:showItem("1",100)
	item:setPosition(x,y)
	flipPic:addChild(item)

	transition.scaleTo(flipPic,{scale = 1, time = 0.2 , onComplete = function ()
		print("onComplete")
	end})
end

function FlipFunLayer:initView()
	-- 灰色背景
	CommonView.blackLayer2()
	:addTo(self)
	--背景板
	self.board = display.newSprite(boardImage)
	:addTo(self)
	:pos(display.cx-40,display.cy+20)
	--关闭
	self.closeBtn = CommonButton.close():addTo(self.board):pos(935,525)
	:scale(0.8)
	:onButtonClicked(function()
		CommonSound.close()
		if self.closeFunc then
			self.closeFunc()
		end
	end)
	--添加时间控件
	self:addTimeWidget()
	--充值按钮
	cc.ui.UIPushButton.new({normal = payBtn1,pressed = payBtn2}, options)
	:pos(660,33)
	:addTo(self.board)
	:onButtonClicked(function ()
		app:pushScene("RechargeScene")
	end)

	self:createNodeBox()
	self:createRefreshBtn()
	self:createAutoBtn()
	self:createProgress()
end

function FlipFunLayer:createRefreshBtn()
	local refreshBtn = cc.ui.UIPushButton.new({normal = refreshBtn1, pressed = refreshBtn2})
	:onButtonClicked(function ()

	end)
	refreshBtn:setPosition(500,33)
	self.board:addChild(refreshBtn)

	local priceLabel = createOutlineLabel({text = "刷新：100", size = 24})
	priceLabel:setPosition(-22,0)
	refreshBtn:addChild(priceLabel)

	local iconSprite = display.newSprite(flipDiamond)
	iconSprite:setPosition(60,0)
	refreshBtn:addChild(iconSprite)
end

--自动翻牌按钮
function FlipFunLayer:createAutoBtn()
	local autoBtn = cc.ui.UIPushButton.new({normal = refreshBtn1, pressed = refreshBtn2})
	:onButtonClicked(function ()

    end)
    autoBtn:setPosition(820,33)
	self.board:addChild(autoBtn)

	self.countLabel = createOutlineLabel({text = "", size = 24})
	autoBtn:addChild(self.countLabel)
end

--充值进度
function FlipFunLayer:createProgress()
    local bgSprite = display.newSprite(stoneBarBg)
    bgSprite:setPosition(660,408)
    self.board:addChild(bgSprite)

    local offsetX = bgSprite:getContentSize().width/2
    local offsetY = bgSprite:getContentSize().height/2

    self.costProgress = cc.ProgressTimer:create(display.newSprite(stoneImage))
    self.costProgress:setType(1)
    self.costProgress:setPosition(offsetX,offsetY)
    self.costProgress:setMidpoint(cc.p(0,1))
    self.costProgress:setBarChangeRate(cc.p(1, 0))
    bgSprite:addChild(self.costProgress,1)

	local param = {text = "" ,color = display.COLOR_WHITE, size = 22,x = offsetX, y = offsetY}
    self.costLabel = createOutlineLabel(param)
    bgSprite:addChild(self.costLabel,2)
end

function FlipFunLayer:createNodeBox()
	for i=1,10 do
		local flipPic = cc.ui.UIPushButton.new({normal = flipBack})		
		:onButtonClicked(function ()
			NetHandler.gameRequest("OpenCardAct",{param1 = i})
		end)
		table.insert(self.allFlipPic, flipPic)
	end

	local nodeBox =  NodeBox.new()
	nodeBox:setCellSize(cc.size(89,125))
	nodeBox:setPosition(660,255)
	nodeBox:setSpace(15,15)
	nodeBox:setUnit(5)
	nodeBox:addElement(self.allFlipPic)
	self.board:addChild(nodeBox,10)
end

--时间控件
function FlipFunLayer:addTimeWidget()
	self.sprite = display.newSprite()
    :align(display.CENTER)
    :addTo(self.board)
    :pos(735, 470)

    self.timeLabel = base.Label.new({text="", size=18, color=cc.c3b(255, 255, 255), border = false})
    :addTo(self.board)
    :pos(805, 450)

    self:schedule(function()
        self:updateTimeShow()
    end, 0.2)
end

-- 更新时间显示
function FlipFunLayer:updateTimeShow()
    local date = ActivityOpenData:getRemainingDate()

    local timestring = string.format("%02d:%02d:%02d", date.hour, date.min, date.sec)

    if date.day < 8 then
        self.sprite:setTexture(string.format("font5_%d.png", date.day))
    end
    self.timeLabel:setString(timestring)

    self.date = date
end

--显示商品列表
function FlipFunLayer:showItem(itemId, count)
    local grid = UserData:createItemView(itemId, {scale=0.7})

    local label = base.Label.new({
        text = tostring(count),
        size = 18,
        color = CommonView.color_white(),
    })
    :align(display.BOTTOM_RIGHT)
    :pos(50, -50)

    grid:addItem(label)

    return grid
end

function FlipFunLayer:updateView()
	local str = string.format("自动翻牌：%d",FlopModel:getLeftTimes())
	self.countLabel:setString(str)

	str = string.format("还需%d",FlopModel:getNeedMoney())
	self.costLabel:setString(str)

	self.costProgress:setPercentage(FlopModel:getNowMoney())
end


function FlipFunLayer:onExit()
	
end

function FlipFunLayer:onEnter()
	self:updateView()
end

return FlipFunLayer