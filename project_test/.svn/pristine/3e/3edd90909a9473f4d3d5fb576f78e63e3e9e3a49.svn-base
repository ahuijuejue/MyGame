--[[
    公会副本
]]

local BasicScene = import("..ui.BasicScene")
local UnionInstanceScene = class("UnionInstanceScene", BasicScene)

local MenuNode = import("..views.main.MenuNode")
local UnionInstanceRuleLayer = import("..views.union.UnionInstanceRuleLayer")
local UnionAgentLayer = import("..views.union.UnionAgentLayer")
local UnionAgentDesLayer = import("..views.union.UnionAgentDesLayer")

local TAG = "UnionInstanceScene"
local skyImage = "Sky_Left.png"
local backImage = "Return.png"
local backImage2 = "Return_Light.png"
local unionArenaBg =  "union_instance_bg.png"
local listImage  = "union_instance_list1.png"
local listImage_ = "union_instance_list2.png"

function UnionInstanceScene:ctor()
	UnionInstanceScene.super.ctor(self,TAG)

    self:initData()
    self:initView()
end

function UnionInstanceScene:initData()

end

function UnionInstanceScene:initView()
	CommonView.background()
	:addTo(self)
	:center()

	CommonView.blackLayer3()
	:addTo(self)

    -- 按钮层
    app:createView("widget.MenuLayer", {wealth="instancePower"}):addTo(self):zorder(10)
    :onBack(function(layer)
        self:pop()
    end)

	self:createMenuNode()

	self.layer_ = display.newLayer():size(960, 640):pos(display.cx,display.cy):align(display.CENTER):addTo(self)
	display.newSprite(unionArenaBg):pos(450, 300):addTo(self.layer_)

	CommonButton.yellow("规则", {color = cc.c3b(252, 242, 181), size = 24})
    :onButtonClicked(function ()
    	self:createRuleLayer()
        print("规则")
    end)
    :pos(235, 112)
    :addTo(self.layer_)

    CommonButton.yellow("雇佣兵", {color = cc.c3b(252, 242, 181), size = 24})
    :onButtonClicked(function ()
        self:createAgentLayer()
        print("雇佣兵")
    end)
    :pos(655, 112)
    :addTo(self.layer_)

    self.listView = cc.TableView:create(cc.size(766,363))
    self.listView:setPosition(115,147)
    self.listView:setDirection(cc.SCROLLVIEW_DIRECTION_VERTICAL)
    self.listView:setVerticalFillOrder(cc.TABLEVIEW_FILL_TOPDOWN)
    self.listView:setDelegate()

    self.listView:registerScriptHandler(handler(self, self.scrollViewDidScroll), 0)
    self.listView:registerScriptHandler(handler(self, self.tableCellTouched), cc.TABLECELL_TOUCHED)
    self.listView:registerScriptHandler(handler(self, self.cellSizeForTable), cc.TABLECELL_SIZE_FOR_INDEX)
    self.listView:registerScriptHandler(handler(self, self.tableCellAtIndex), cc.TABLECELL_SIZE_AT_INDEX)
    self.listView:registerScriptHandler(handler(self, self.numberOfCellsInTableView), cc.NUMBER_OF_CELLS_IN_TABLEVIEW)
    self.listView:reloadData()
    self.layer_:addChild(self.listView)

end

function UnionInstanceScene:scrollViewDidScroll(table)

end

function UnionInstanceScene:tableCellTouched(table,cell)
	print("cellIdx:"..cell:getIdx())
end

function UnionInstanceScene:cellSizeForTable(table,idx)
	  return 105
end

function UnionInstanceScene:tableCellAtIndex(table,idx)
	  return self:createCell(idx)
end

function UnionInstanceScene:numberOfCellsInTableView(table)
	  return 10
end

function UnionInstanceScene:createCell(idx)
	local cell = cc.TableViewCell:new()
	cell:setIdx(idx)

    local bgSprite = display.newSprite(listImage)
    bgSprite:setAnchorPoint(0,0)
    cell:addChild(bgSprite)

    display.newSprite("Mail_Circle.png"):scale(0.75):pos(80, 50):addTo(cell)
    display.newSprite(UserData.headIcon):pos(80, 47):addTo(cell):scale(0.7)
    display.newTTFLabel({text = "第"..(idx+1).."章".." 异世界", color = cc.c3b(252, 242, 181), size = 24}):pos(335, 50):addTo(cell)

    if UnionListData:getLevel(tonumber(UnionListData.unionData.exp)) >= idx+1 then  -- 上一章通过了 则出现
        display.newSprite(listImage_):pos(335, 50):addTo(cell)
        display.newTTFLabel({text = "公会lv"..(idx+1).."开启", color = cc.c3b(252, 242, 181), size = 16}):pos(585, 75):addTo(cell)

        CommonButton.yellow("进入副本", {color = cc.c3b(252, 242, 181), size = 24})
        :onButtonClicked(function ()
            if UnionListData:getLevel(tonumber(UnionListData.unionData.exp)) >= idx+1 then  -- 工会经验到规定值 开启
                if UserData.unionPower > 0 then
                    print("进入副本")
                else
                    --todo
                end
            else
                showToast({text = "需要公会多少级开启副本"})
            end
        end)
        :pos(585, 35)
        :addTo(cell)
        :scale(0.9)
    end

    return cell
end

function UnionInstanceScene:createMenuNode()
	local menuNode = MenuNode.new()
    menuNode:setPosition(display.width-60,50)
    menuNode:setHorBtnVisible(false)
    self:addChild(menuNode,4)
end

-- 副本规则
function UnionInstanceScene:createRuleLayer()
	self.ruleLayer = UnionInstanceRuleLayer.new()
	self.ruleLayer:addTo(self, 10)
	self.ruleLayer.delegate = self
    self.listView:setTouchEnabled(false)
end

function UnionInstanceScene:removeRuleLayer()
    if self.ruleLayer then
        self.ruleLayer:removeFromParent()
        self.ruleLabel = nil
    end
    self.listView:setTouchEnabled(true)
end

-- 副本雇佣兵
function UnionInstanceScene:createAgentLayer()
    self.agentLayer = UnionAgentLayer.new()
    self.agentLayer:addTo(self, 10)
    self.agentLayer.delegate = self
    self.listView:setTouchEnabled(false)
end

function UnionInstanceScene:removeAgentLayer()
    if self.agentLayer then
        self.agentLayer:removeFromParent()
        self.agentLayer = nil
    end
    self.listView:setTouchEnabled(true)
end

-- 副本雇佣兵说明
function UnionInstanceScene:createAgentDesLayer()
    self.agentDesLayer = UnionAgentDesLayer.new()
    self.agentDesLayer:addTo(self, 10)
    self.agentDesLayer.delegate = self
end

function UnionInstanceScene:removeAgentDesLayer()
    if self.agentDesLayer then
        self.agentDesLayer:removeFromParent()
        self.agentDesLayer = nil
    end
end

function UnionInstanceScene:updateData()
end

function UnionInstanceScene:updateView()
end

function UnionInstanceScene:netCallback(event)
    local data = event.data
    local order = data.order
    -- if order == OperationCode.OpenShopProcess then
    -- end
end

function UnionInstanceScene:onEnter()
    self.netEvent = GameDispatcher:addEventListener(EVENT_CONSTANT.NET_CALLBACK,handler(self,self.netCallback))
end

function UnionInstanceScene:onExit()
	GameDispatcher:removeEventListener(self.netEvent)
end

return UnionInstanceScene
