--[[
	老虎机活动 31001  购买 31002
--]]
local TigerLayer = class("TigerLayer",function()
	return display.newNode()
end)
local scheduler = require(cc.PACKAGE_NAME .. ".scheduler")
local boardImage = "Tiger_Board.png"
local btnFive = "Pay_Five.png"
local btnFiveSelect = "Pay_Five_Select.png"
local btnOne = "Pay_One.png"
local btnOneSelect = "Pay_One_Select.png"
local discOne = "DiscOne.png"
local discTwo = "DiscTwo.png"
local lightRing = "LightRing.png"


function TigerLayer:ctor()
    self.lightRingSprite = {}
    self.movePos = 1
	self:initView()

    self.fivePos = {}    
    self:getAllPos() --获取所有点坐标self.fivePos
    self:showItemsView()
	self:addNodeEventListener(cc.NODE_EVENT,function (event)
		if event.name == "enter" then
			self:onEnter()
		elseif event.name == "exit" then
			self:onExit()
		end
	end)
end

--显示商品列表
function TigerLayer:showItem(itemId, count)
    local grid = UserData:createItemView(itemId, {scale=0.7})

    local label = base.Label.new({
        text = tostring(count),
        size = 18,
        color = CommonView.color_white(),
    })
    :align(display.BOTTOM_RIGHT)
    :pos(50, -50)

    grid:addItem(label)

    return grid
end

--显示商品
function TigerLayer:showItemsView()
    -- self.layer1:removeAllChildren()
    for j=1,#(SlotModel.itemsData) do
        self:showItem(tostring(SlotModel.itemsData[j].param1), tonumber(SlotModel.itemsData[j].param3))
        :addTo(self.board)
        :pos(self:getPos(j))
        :zorder(10)
    end     

    -- self:updateBuyBtn(index)    --TODO
end

function TigerLayer:initView()
	-- 灰层背景
	CommonView.blackLayer2()
    :addTo(self)

    --底板
    self.board = display.newSprite(boardImage)
    :addTo(self)
    :pos(display.cx,display.cy)

    -- 关闭按钮
	self.closeBtn = CommonButton.close():addTo(self.board):pos(862,525)
	:scale(0.8)
	:onButtonClicked(function()
		CommonSound.close()
		self:removeFromParent()
	end)

    --购买五次按钮
    self.btnFive = cc.ui.UIPushButton.new({normal = btnFive,pressed = btnFiveSelect})
    :addTo(self.board)
    :pos(695,75)
    :onButtonClicked(function ()
    	print("购买5次")
        if UserData.diamond < 900 then
            showToast({text="钻石不足"})
        else
            NetHandler.gameRequest("OnearmBundit",{param1  = 2})
        end
        self.closeBtn:setButtonEnabled(false)
        self.lightRing:setVisible(false)
        self.btnFive:setTouchEnabled(false)
        self.numFive = math.random(5,8)
        --随机生成五个
        self:createFive()
        
        
    end)
    --金币500
    base.Label.new({text = SlotModel.price2,color=CommonView.color_white(), size=32,border = false,shadow = 1})
    :align(display.CENTER)
    :addTo(self.btnFive)
    :pos(-72, -18)

    --光圈
    self.lightRing = display.newSprite(lightRing)
    :addTo(self.board)
    :pos(359,372)
    self.lightRing:setVisible(true)
    --购买一次
    self.btnOne = cc.ui.UIPushButton.new({normal = btnOne,pressed = btnOneSelect}, options)
    :addTo(self.board)
    :pos(440,75)
    :onButtonClicked(function ()
        if UserData.diamond < 200 then
            showToast({text="钻石不足"})
        else
            NetHandler.gameRequest("OnearmBundit",{param1  = 1})
            self.closeBtn:setButtonEnabled(false)
            self.lightRing:setVisible(true)
            self.btnOne:setTouchEnabled(false)
            self.num = math.random(4,6)
            print("购买1次随机数是.."..self.num)
            self.lightRing:setPosition(359,372)
            --光圈动画
            self:playLightRing()
        end

    end)
    --金币200
    base.Label.new({text = SlotModel.price1,color=CommonView.color_white(), size=32,border = false,shadow = 1})
    :align(display.CENTER)
    :addTo(self.btnOne)
    :pos(-72, -18)
    --2折
    display.newSprite(discTwo)
    :addTo(self.btnFive)
    :pos(-76,7)
    --一折
    display.newSprite(discOne)
    :addTo(self.btnOne)
    :pos(-91,8)

    for i=1,5 do
        self.fiveImage = display.newSprite(lightRing)
        :addTo(self.board)
        self.fiveImage:setVisible(false)
        table.insert(self.lightRingSprite, self.fiveImage)
    end

end

    local numberPos1 = 8   --停止 2
    local numberPos2 = nil --减速 8

    if numberPos1 >= 7 then
        numberPos2 = numberPos1 - 7
    else
        numberPos2 = numberPos1 + 6
    end
    local numBlink = 0 --闪动次数

function TigerLayer:createFive()
    --生成
    local N = 12
    local array = {0,0,0,0,0}

    for i = 1 , 5 do
        newrandomseed()
        local x = math.random(1,12)
        function isExist(value)
            for i,v in ipairs(array) do
                if v == value then
                    return true
                end
            end
            return false
        end
        while isExist(x)  do
            newrandomseed()
            x = math.random(1,12)
        end
        array[i] = x
    end
    -- 购买五次定时器 
    scheduler.performWithDelayGlobal(function ()
        numBlink = numBlink + 1
        for i=1,5 do
            self.lightRingSprite[i]:setVisible(true)
            self.lightRingSprite[i]:setPosition(self:getPos(array[i]))
        end
        if numBlink >= self.numFive+1 then
            self:stopFivePos() --停止定时器,固定五个位置
        else
            self:createFive()
        end
        
    end,0.08)

end

--固定五个位置
function TigerLayer:stopFivePos()
    print("固定五个位置")
    for i=1,5 do
        self.lightRingSprite[i]:setVisible(false)
        -- self.lightRingSprite[i]:setPosition(self:getPos(i))
    end
    self.btnFive:setTouchEnabled(true)
    self.closeBtn:setButtonEnabled(true)
    numBlink = 0
end

function TigerLayer:getPos(pos)
    local x = self.fivePos[pos][1]
    local y = self.fivePos[pos][2]

    return x,y
end

function TigerLayer:getAllPos()  --359,372
    local x = 359
    local y = 372

    for x=359,771,103 do
        table.insert(self.fivePos,{x,y})            
    end
    x = 771
    for y=268,100,-103 do
        -- print("打印"..y)
        table.insert(self.fivePos,{x,y})
    end
    y = 165
    for x=668,359,-103 do
       table.insert(self.fivePos,{x,y})
    end
    x = 359
    y = 268  
    table.insert(self.fivePos,{x,y})

end

function TigerLayer:playLightRing()

    local x = self.lightRing:getPositionX()
    local y = self.lightRing:getPositionY()
    local time = 0.01
    if self.movePos < 13 then
        time = 0.13 - math.pow(self.movePos,2) * 0.0008 
    elseif self.movePos >= self.num*12+numberPos2 then
        -- print("===时间改变===")
        time = self.movePos * 0.005
    end

    local pos = math.mod(self.movePos,12)
    -- print("取模是的值···"..pos.."..self.movePos的值是.."..self.movePos.."最后的时间是.."..time)
    if pos < 5 and pos > 0 then
        x = x + 103
    elseif pos < 7 and pos >= 5 then
        y = y - 103
    elseif pos < 11 and pos >= 7 then
        x = x - 103
    else
        y = y + 103
    end

    -- 购买一次定时器  
    scheduler.performWithDelayGlobal(function ()
        self.movePos = self.movePos+1
        self.lightRing:setPosition(x,y)
        if numberPos1 < numberPos2 then
                if self.movePos >=self.num*12+numberPos2 and self.movePos < (self.num+1)*12+numberPos1 then
                    self:playLightRing()
                elseif self.movePos >=  (self.num+1)*12+numberPos1 then
                    self.btnOne:setTouchEnabled(true)
                    self.closeBtn:setButtonEnabled(true)
                    self.movePos = 1
                    -- print("移动结束.小于."..self.movePos)
                else
                    self:playLightRing()
                end

        else
                if self.movePos >=self.num*12+numberPos2 and self.movePos < self.num*12+numberPos1 then
                    self:playLightRing()
   
                elseif self.movePos >  self.num*12+numberPos2 then
                       self.btnOne:setTouchEnabled(true)
                       self.closeBtn:setButtonEnabled(true)
                       self.movePos = 1
                    -- print("移动结束 大于.."..self.movePos)
                else
                    self:playLightRing()
                end
        end

    end,time)
end

function TigerLayer:onEnter()
	CommonView.animation_show_out(self.board)
end

function TigerLayer:onExit()
    self.fivePos = nil
    self.board:removeFromParent()
    self.board = nil
end

return TigerLayer