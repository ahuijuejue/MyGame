
local ChatLeftView = class("ChatLeftView", function()
	return display.newNode()
end)

function ChatLeftView:ctor()

    self:initData()
    self:initView()

end

function ChatLeftView:initData()
	self.showData = {}
end

function ChatLeftView:initView()
	self.back = display.newSprite("left_back.png")
    :pos(display.left+130,display.bottom)
    :addTo(self)

	self.listView = base.ListView.new({
		viewRect = cc.rect(0, 0, 320, 105),
		itemSize = cc.size(295, 33),
	}):addTo(self.back,3)
	:pos(0, 3)
	:onTouch(handler(self, self.touchListener))
	:setTouchType(false)

end

function ChatLeftView:touchListener(event)
    if "clicked" == event.name then
    	self.delegate.chatView.sectionIndex = 2
    	self.delegate.chatView.chatMsg = ""
		self.delegate.chatView:show()
		self.delegate.chatView.textfield:show()
		self.delegate.chatView:updateData()
		self.delegate.chatView:updateView()
    end
end

function ChatLeftView:updateData()
    self.showData = {}

	if ChatData.setState[1] == "1" and ChatData.setState[2] == "1" and ChatData.setState[3] == "1" then
		for k,v in pairs(ChatData.allLeftData) do
			table.insert(self.showData, {
				id = tonumber(k),
				channelType = v.channelType,
				name = v.name,
				msg = v.msg,
				})
		end
    elseif ChatData.setState[1] == "1" and ChatData.setState[2] == "1" and ChatData.setState[3] == "0" then
    	for k,v in pairs(ChatData.allLeftData) do
    		if v.channelType == "2" or v.channelType == "3" then
    			table.insert(self.showData, {
				id = tonumber(k),
				channelType = v.channelType,
				name = v.name,
				msg = v.msg,
				})
    		end
		end
    elseif ChatData.setState[1] == "1" and ChatData.setState[2] == "0" and ChatData.setState[3] == "1" then
    	for k,v in pairs(ChatData.allLeftData) do
    		if v.channelType == "2" or v.channelType == "4" then
    			table.insert(self.showData, {
				id = tonumber(k),
				channelType = v.channelType,
				name = v.name,
				msg = v.msg,
				})
    		end
		end
	elseif ChatData.setState[1] == "0" and ChatData.setState[2] == "1" and ChatData.setState[3] == "1" then
    	for k,v in pairs(ChatData.allLeftData) do
    		if v.channelType == "3" or v.channelType == "4" then
    			table.insert(self.showData, {
				id = tonumber(k),
				channelType = v.channelType,
				name = v.name,
				msg = v.msg,
				})
    		end
		end
	elseif ChatData.setState[1] == "1" and ChatData.setState[2] == "0" and ChatData.setState[3] == "0" then
		for k,v in pairs(ChatData.sysLeftData) do
			table.insert(self.showData, {
			id = tonumber(k),
			channelType = v.channelType,
			name = v.name,
			msg = v.msg,
			})
		end
	elseif ChatData.setState[1] == "0" and ChatData.setState[2] == "1" and ChatData.setState[3] == "0" then
		for k,v in pairs(ChatData.worldLeftData) do
			table.insert(self.showData, {
			id = tonumber(k),
			channelType = v.channelType,
			name = v.name,
			msg = v.msg,
			})
		end
	elseif ChatData.setState[1] == "0" and ChatData.setState[2] == "0" and ChatData.setState[3] == "1" then
		for k,v in pairs(ChatData.unionLeftData) do
			table.insert(self.showData, {
			id = tonumber(k),
			channelType = v.channelType,
			name = v.name,
			msg = v.msg,
			})
		end
	end

end

function ChatLeftView:updateView()

	self.listView:removeAllItems()
	if #self.showData == 0 then
		self.listView:addItems(1,function(event)
			local grid = base.Grid.new()
			grid:removeItems():addItems({createOutlineLabel({text = "暂无聊天消息",size = 18}):pos(-65,0)})
			return grid
		end)
	else
		for i=1,#self.showData do
	    	local itemHeight = 0
	    	local msg_ = string.format(self.showData[i].name..":%s", self.showData[i].msg)
	    	local msg = base.TalkLabel.new({
		    		text  = msg_,
					size  = 18,
					dimensions = cc.size(250,0),
					scale = 0.4,
		    	})
			itemHeight = 20*msg:getLines() + 13
	    	self.listView:addSizeItem(cc.size(295,itemHeight),function(event)
				local data  = self.showData[i]
				local grid = base.Grid.new()
				self:setGridShow(grid, data)
				return grid
			    end)
	    end
	end
    self.listView:reload()
end

function ChatLeftView:setGridShow(grid, data)
	if data.channelType == "2" then -- 系统消息
		local msg = base.TalkLabel.new({
	    		text  = data.msg,
				size  = 18,
				dimensions = cc.size(250,0),
				scale = 0.28,
	    	})
	    msg:pos(-100, 15-17*msg:getLines())

	    grid:removeItems()
	    :addItems({
	        display.newSprite("System_Tip.png"):pos(-130,2):scale(0.7),
	        msg,
	    	})
	elseif data.channelType == "3" then -- 世界消息
		local name = string.format("<{0,248,248}%s:>", data.name)  --48,200,248
		local msg = string.format(name.."%s", data.msg)
		local msg = base.TalkLabel.new({
	    		text  = msg,
				size  = 18,
				dimensions = cc.size(250,0),
				scale = 0.28,
	    	})
		if msg:getLines() == 1 then
			msg:pos(-100, 10-20*msg:getLines())
		    grid:removeItems()
		    :addItems({
		        display.newSprite("World_Tip.png"):pos(-130,2):scale(0.7),
		        msg,
		    	})
		else
			msg:pos(-100, 17-15*msg:getLines())
		    grid:removeItems()
		    :addItems({
		        display.newSprite("World_Tip.png"):pos(-130,msg:getLines()*6):scale(0.7),
		        msg,
		    	})
		end
	end
end

return ChatLeftView