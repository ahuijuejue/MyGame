local UnionListData = class("UnionListData")

function UnionListData:ctor()
	self.unionShowList = {}  -- 加入公会列表显示
	self.unionFindList = {}  -- 查找公会结果

	self.unionData = {}   -- 已加入的公会信息
	self.unionMemberData = {}  -- 公会成员信息

	-- 是否是新创建的公会
	self.isTheNewUnion = 0
	-- 是否通过申请
	self.isApplyPass = 0
	-- 在公会中的职位
    self.unionDuty = "0"
    -- 自动退出公会后是否过一小时 即是否可以申请公会
    self.isCanApply = 1
    -- 已经发送邮件的次数
    self.mailCounts = 0
    --礼拜状态
    self.isSignIn = {"0", "0", "0"}
    -- 申请的公会列表
    self.applyUnions = {}
    -- 日志内容
    self.logMsg = {}
    -- 申请列表
    self.applyData = {}
    -- 公会等级对应功能
	self.arr = {}
    local cfgs = GameConfig["ConsortiaExp"]
	for k,v in pairs(cfgs) do
		table.insert(self.arr, {
			level 		= tonumber(k), 				-- 公会等级
			exp 		= v.ConsortiaExp, 	-- vip经验
			memberNum   = v.PlayerNumber,   -- 成员数量
			admNum      = v.AdministratorNumber,   -- 管理员数量
			vcechairmanNum = v.VicechairmanNumber, -- 副会长数量
			isOpen = v.ConsortiaInstance, -- 是否开启公会副本
		})
	end
	table.sort(self.arr, function(a, b)
		return a.level < b.level
	end)
	--------------------------------------------------

	-- 公会战争之地公会列表信息
	self.unionArenaList = {}
	-- 挑战工会的公会信息
    -- self.unionArenaId = ""
    self.unionArenaMembers = {}
    -- 剩余挑战次数
    self.times = 0

end

-- 查找公会的结果
function UnionListData:insertFindData( model )
	table.insert(self.unionFindList, model)
end

-- 显示的所有公会列表
function UnionListData:insertShowData( model )
	if not self:isContainUnion(model) then
		table.insert(self.unionShowList, model)
	end
end
function UnionListData:isContainUnion( model )
	for i,v in ipairs(self.unionShowList) do
		if model.id == v.id then
		   return true
		end
	end
	return false
end

-- 已加入的公会信息
function UnionListData:insertUnionData( model )
	if #self.unionData >= 1 then
		self:updateUnionData(model)
	else
		self.unionData = model
	end
end
function UnionListData:updateUnionData(model)
	for k,v in pairs(model) do
		self.unionData[k] = v
	end
end

-- 成员信息
function UnionListData:insertUnionMemberData( model )
	if not self:isContainUnionMember(model) then
		table.insert(self.unionMemberData, model)
	else
		print("该成员已存在！")
	end

	--根据等级排序
    local sortFunc = function (a,b)
        if a.exp > b.exp then
            return true
        elseif a.exp == b.exp then
            if a.duty < b.duty then
                return true
            else
                return false
            end
        else
            return false
        end
    end
    table.sort(self.unionMemberData,sortFunc)
end
function UnionListData:isContainUnionMember( model )
	for i,v in ipairs(self.unionMemberData) do
		if model.id == v.id then
		   return true
		end
	end
	return false
end

-- 签到状态
function UnionListData:setIsSignIn(signInArr)
	for i=1,#signInArr do
    	self.isSignIn[i] = signInArr[i]
    end
end

-- 已申请过的公会
function UnionListData:setApplyUnions(param)
	for i=1,#param do
		self.applyUnions[i] = param[i]
	end
end

-- 在公会中的职位
function UnionListData:getUnionDuty()
	if #self.unionMemberData > 0 then
		for i,v in ipairs(self.unionMemberData) do
			if v.id == UserData.userId then
				self.unionDuty = v.duty
				return self.unionDuty
			end
		end
	else
		return self.unionDuty
	end
end

function UnionListData:setUnionExp(exp)
	local exp_ = tonumber(self.unionData.exp)
	exp_ = exp_ + exp
	self.unionData.exp = tostring(exp_)
	-- self:dispatchEvent({name = EVENT_CONSTANT.UPDATE_USER_VIP})
end
---------------------------------------------------------------------
-- 最大公会等级
function UnionListData:getUnionLevelMax()
    return self.arr[#self.arr].level
end

-- 最大公会等级对应经验
function UnionListData:getUnionExpMax()
    return self.arr[#self.arr].exp
end

function UnionListData:getData(exp)
	exp = exp or tonumber(self.unionData.exp)
	local preData
	for i,v in ipairs(self.arr) do
		if exp < v.exp then
			return preData, v
		else
			preData = v
		end
	end
	return preData, preData
end

function UnionListData:getLevel(exp)
	local data = self:getData(exp)
	return data.level
end

-- 下一级对应的经验
function UnionListData:getExpMax(exp)
	local _, nextData = self:getData(exp)
	return nextData.exp
end
---------------------------------------------------------------------

-- 更新日志
function UnionListData:reloadLogMsg(param)
	for i,v in ipairs(param) do
		self.logMsg[i] = v
	end
end

-- 申请列表
function UnionListData:insertApplyData(param)
	if not self:isContainUnionApply(param) then
		table.insert(self.applyData, param)
	end
end
function UnionListData:isContainUnionApply( param )
	for i,v in ipairs(self.applyData) do
		if param.userId == v.userId then
		   return true
		end
	end
	return false
end

---------------------------------------------------------------------
-- 申请人红点
function UnionListData:isShowSignRedPoint()
    for i,v in ipairs(self.isSignIn) do
        if v == "0" and UserData.unionId ~= "" then
        	return true
        end
    end
    return false
end

-- 签到红点
function UnionListData:isShowApplyRedPoint()
    if #self.applyData > 0 then
    	return true
    end
    return false
end
---------------------------------------------------------------------
-- 显示的所有公会战争之地列表
function UnionListData:insertUnionAreanList( model )
	if not self:isContainUnionArena(model) then
		table.insert(self.unionArenaList, model)
	end
end
function UnionListData:isContainUnionArena( model )
	for i,v in ipairs(self.unionArenaList) do
		if model.id == v.id then
		   return true
		end
	end
	return false
end

-- 显示所选公会成员信息
function UnionListData:insertUnionArenaMember( model )
	if not self:isContainUnionArenaMember(model) then
		table.insert(self.unionArenaMembers, model)
	end
end
function UnionListData:isContainUnionArenaMember( model )
	for i,v in ipairs(self.unionArenaMembers) do
		if model.userid == v.userid then
		   return true
		end
	end
	return false
end
---------------------------------------------------------------------
-- 显示的所有公会列表
--删除聊天数据
function UnionListData:cleanData()
	for i,v in ipairs(self.unionFindList) do
		v = nil
	end
	self.unionFindList = {}

	for i,v in ipairs(self.unionShowList) do
		v = nil
	end
	self.unionShowList = {}

	for i,v in ipairs(self.unionData) do
		v = nil
	end
	self.unionData = {}

	for i,v in ipairs(self.unionMemberData) do
		v = nil
	end
	self.unionMemberData = {}

	for i,v in ipairs(self.isSignIn) do
		v = nil
	end
	self.isSignIn = {}

	for i,v in ipairs(self.applyUnions) do
		v = nil
	end
	self.applyUnions = {}

	for i,v in ipairs(self.logMsg) do
		v = nil
	end
	self.logMsg = {}

	for i,v in ipairs(self.applyData) do
		v = nil
	end
	self.applyData = {}

    for i,v in ipairs(self.unionArenaList) do
		v = nil
	end
	self.unionArenaList = {}

	for i,v in ipairs(self.unionArenaMembers) do
		v = nil
	end
    self.unionArenaMembers = {}

	self.unionDuty = "0"
	self.isCanApply = 1
	self.mailCounts = 0
	self.isTheNewUnion = 0
	self.isApplyPass = 0
	UserData.unionId = ""
	-- self.unionArenaId = ""
end

return UnionListData
